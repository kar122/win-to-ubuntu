{
   "$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "location":{
         "type":"string",
         "defaultValue":"[resourceGroup().location]"
      },
      "adminUsername":{
         "type":"string",
         "defaultValue":"visionai"
      },
      "adminPassword":{
         "type":"securestring"
      },
      "vmSize":{
         "type":"string",
         "defaultValue":"Standard_NC6_v3"
      },
      "storageAccountName":{
         "type":"string"
      }
   },
   "variables":{
      
   },
   "resources":[
      {
         "name":"[parameters('location')]",
         "type":"Microsoft.Compute/virtualMachines",
         "apiVersion":"2021-03-01",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[resourceId('Microsoft.Network/networkInterfaces', 'NetworkInterface')]"
         ],
         "tags":{
            "displayName":"gpuVM"
         },
         "properties":{
            "hardwareProfile":{
               "vmSize":"[parameters('vmSize')]"
            },
            "osProfile":{
               "computerName":"gpuVM",
               "adminUsername":"[parameters('adminUsername')]",
               "adminPassword":"[parameters('adminPassword')]"
            },
            "storageProfile":{
               "imageReference":{
                  "publisher":"Canonical",
                  "offer":"UbuntuServer",
                  "sku":"18.04-LTS",
                  "version":"latest"
               },
               "osDisk":{
                  "name":"OSDisk",
                  "caching":"ReadWrite",
                  "createOption":"FromImage"
               }
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces', 'NetworkInterface')]"
                  }
               ]
            },
            "diagnosticsProfile":{
               "bootDiagnostics":{
                  "enabled":true,
                  "storageUri":"[reference(resourceId('Microsoft.Storage/storageAccounts/', toLower(parameters('storageAccountName')))).primaryEndpoints.blob]"
               }
            }         }
      },
      {
         "name":"[toLower(parameters('storageAccountName'))]",
         "type":"Microsoft.Storage/storageAccounts",
         "apiVersion":"2021-04-01",
         "location":"[parameters('location')]",
         "tags":{
            "displayName":"Storage Account"
         },
         "sku":{
            "name":"Standard_LRS"
         },
         "kind":"Storage"
      },
      {
         "name":"PublicIP",
         "type":"Microsoft.Network/publicIPAddresses",
         "apiVersion":"2020-11-01",
         "location":"[parameters('location')]",
         "tags":{
            "displayName":"PublicIPAddress"
         },
         "properties":{
            "publicIPAllocationMethod":"Dynamic",
            "dnsSettings":{
               "domainNameLabel":"[toLower('gpuVM')]"
            }
         }
      },
      {
         "name":"nsg",
         "type":"Microsoft.Network/networkSecurityGroups",
         "apiVersion":"2020-11-01",
         "location":"[parameters('location')]",
         "properties":{
            "securityRules":[
               {
                  "name":"nsgRule1",
                  "properties":{
                     "description":"description",
                     "protocol":"Tcp",
                     "sourcePortRange":"*",
                     "destinationPortRange":"22",
                     "sourceAddressPrefix":"*",
                     "destinationAddressPrefix":"*",
                     "access":"Allow",
                     "priority":100,
                     "direction":"Inbound"
                  }
               }
            ]
         }
      },
      {
         "name":"VirtualNetwork",
         "type":"Microsoft.Network/virtualNetworks",
         "apiVersion":"2020-11-01",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[resourceId('Microsoft.Network/networkSecurityGroups', 'nsg')]"
         ],
         "tags":{
            "displayName":"VirtualNetwork"
         },
         "properties":{
            "addressSpace":{
               "addressPrefixes":[
                  "10.0.0.0/16"
               ]
            },
            "subnets":[
               {
                  "name":"VirtualNetwork-Subnet",
                  "properties":{
                     "addressPrefix":"10.0.0.0/24",
                     "networkSecurityGroup":{
                        "id":"[resourceId('Microsoft.Network/networkSecurityGroups', 'nsg')]"
                     }
                  }
               }
            ]
         }
      },
      {
         "name":"NetworkInterface",
         "type":"Microsoft.Network/networkInterfaces",
         "apiVersion":"2020-11-01",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[resourceId('Microsoft.Network/publicIPAddresses', 'PublicIP')]",
            "[resourceId('Microsoft.Network/virtualNetworks', 'VirtualNetwork')]"
         ],
         "tags":{
            "displayName":"NetworkInterface"
         },
         "properties":{
            "ipConfigurations":[
               {
                  "name":"ipConfig1",
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "publicIPAddress":{
                        "id":"[resourceId('Microsoft.Network/publicIPAddresses', 'PublicIP')]"
                     },
                     "subnet":{
                        "id":"[resourceId('Microsoft.Network/virtualNetworks/subnets', 'VirtualNetwork', 'VirtualNetwork-Subnet')]"
                     }
                  }
               }
            ]
         }
      }
   ],
   "outputs":{
      "vmSize":{
         "type":"string",
         "value":"[parameters('vmSize')]"
      }
   }
}
